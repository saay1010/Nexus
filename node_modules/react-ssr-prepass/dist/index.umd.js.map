{"version":3,"file":"index.umd.js","sources":["../src/util.js","../src/index.js"],"sourcesContent":["// @flow\r\n\r\n/**\r\n * Copy all properties from `props` onto `obj`.\r\n * @param {object} obj Object onto which properties should be copied.\r\n * @param {object} props Object from which to copy properties.\r\n * @returns {object}\r\n * @private\r\n */\r\nexport function assign(obj /*: Object */, props /*: Object */) /*: Object */ {\r\n  for (let i in props) obj[i] = props[i];\r\n  return obj;\r\n}\r\n\r\n/**\r\n * Get flattened children from the children prop\r\n * @param {Array} accumulator\r\n * @param {any} children A `props.children` opaque object.\r\n * @returns {Array} accumulator\r\n * @private\r\n */\r\nexport function getChildren(\r\n  accumulator /*: Array<Object> */,\r\n  children /*: Array<Object> | Object */\r\n) /*: Array<Object> */ {\r\n  if (Array.isArray(children)) {\r\n    children.reduce(getChildren, accumulator);\r\n  } else if (children != null && children !== false) {\r\n    accumulator.push(children);\r\n  }\r\n  return accumulator;\r\n}\r\n","// @flow\r\nimport { assign, getChildren } from \"./util\";\r\nimport { options, Fragment, Component } from \"preact\";\r\nimport { Suspense } from \"preact/compat\";\r\n\r\nconst createContextDefaultValue = \"__p\";\r\nconst createContextDefaultValueNew = \"__\";\r\nconst _skipEffects = \"__s\";\r\n\r\n/*::\r\ntype VNode = {\r\n\ttype: string | Function,\r\n\tprops: Object,\r\n\t__c: typeof Component,\r\n};\r\n\r\ntype VNodes = VNode | Array<VNode>;\r\n\r\ntype Options = {\r\n\trender: (vnode: VNode) => void;\r\n};\r\n*/\r\n\r\nexport default function prepass(\r\n  vnode /*: VNode */,\r\n  visitor /*: ?(vnode: VNode, component: typeof Component) => ?Promise<any> */,\r\n  context /*: ?Object */\r\n) /*: Promise<any|Array<any>> */ {\r\n  // null, boolean, text, number \"vnodes\" need to prepassing...\r\n  if (vnode == null || typeof vnode !== \"object\") {\r\n    return Promise.resolve();\r\n  }\r\n\r\n  let nodeName = vnode.type,\r\n    props = vnode.props,\r\n    children = [];\r\n  context = context || {};\r\n\r\n  if (\r\n    typeof nodeName === \"function\" &&\r\n    nodeName !== Fragment &&\r\n    nodeName !== Suspense // We're handling Suspense the same way as we do fragments as we do not want something to catch promises during prepass\r\n  ) {\r\n    let doRender /* : () => Promise<void> */;\r\n    let c = (vnode.__c = new Component(props, context));\r\n    // initialize components in dirty state so setState() doesn't enqueue re-rendering:\r\n    c.__d = true;\r\n    c.__v = vnode;\r\n    /* istanbul ignore else */\r\n    if (c.state === undefined) {\r\n      c.state = {};\r\n    }\r\n\r\n    let isClassComponent = false;\r\n\r\n    // Necessary for createContext api. Setting this property will pass\r\n    // the context value as `this.context` just for this component.\r\n    let cxType = nodeName.contextType;\r\n    let provider = cxType && context[cxType.__c];\r\n    let cctx =\r\n      cxType != null\r\n        ? provider\r\n          ? provider.props.value\r\n          : cxType[createContextDefaultValue] ||\r\n            cxType[createContextDefaultValueNew]\r\n        : context;\r\n\r\n    if (\r\n      !nodeName.prototype ||\r\n      typeof nodeName.prototype.render !== \"function\"\r\n    ) {\r\n      // stateless functional components\r\n      doRender = () => {\r\n        try {\r\n          const previousSkipEffects = options[_skipEffects];\r\n          options[_skipEffects] = true;\r\n          // options.render was renamed to _render (mangled to __r)\r\n          if (options.render) options.render(vnode);\r\n          if (options.__r) options.__r(vnode);\r\n          const renderResult = Promise.resolve(\r\n            nodeName.call(vnode.__c, props, cctx)\r\n          );\r\n          options[_skipEffects] = previousSkipEffects;\r\n          return renderResult;\r\n        } catch (e) {\r\n          if (e && e.then) {\r\n            return e.then(doRender, doRender);\r\n          }\r\n\r\n          return Promise.reject(e);\r\n        }\r\n      };\r\n    } else {\r\n      isClassComponent = true;\r\n\r\n      // class-based components\r\n      // c = new nodeName(props, context);\r\n      c = vnode.__c = new nodeName(props, cctx);\r\n      // initialize components in dirty state so setState() doesn't enqueue re-rendering:\r\n      c.__d = true;\r\n      c.__v = vnode;\r\n      c.props = props;\r\n      c.context = cctx;\r\n      if (c.state === undefined) {\r\n        c.state = {};\r\n      }\r\n\r\n      // TODO: does react-ssr-prepass call the visitor before lifecycle hooks?\r\n      if (nodeName.getDerivedStateFromProps)\r\n        c.state = assign(\r\n          assign({}, c.state),\r\n          nodeName.getDerivedStateFromProps(c.props, c.state)\r\n        );\r\n      else if (c.componentWillMount) c.componentWillMount();\r\n\r\n      doRender = () => {\r\n        try {\r\n          // options.render was renamed to _render (mangled to __r)\r\n          if (options.render) options.render(vnode);\r\n          if (options.__r) options.__r(vnode);\r\n          return Promise.resolve(c.render(c.props, c.state, c.context));\r\n        } catch (e) {\r\n          if (e && e.then) {\r\n            return e.then(doRender, doRender);\r\n          }\r\n\r\n          return Promise.reject(e);\r\n        }\r\n      };\r\n    }\r\n\r\n    return (visitor\r\n      ? (\r\n          visitor(vnode, isClassComponent ? c : undefined) || Promise.resolve()\r\n        ).then(doRender)\r\n      : doRender()\r\n    ).then((rendered) => {\r\n      if (c.getChildContext) {\r\n        context = assign(assign({}, context), c.getChildContext());\r\n      }\r\n\r\n      if (Array.isArray(rendered)) {\r\n        return Promise.all(\r\n          rendered.map((node) => prepass(node, visitor, context))\r\n        );\r\n      }\r\n\r\n      return prepass(rendered, visitor, context);\r\n    });\r\n  }\r\n\r\n  if (props && getChildren((children = []), props.children).length) {\r\n    return Promise.all(\r\n      children.map((child) => prepass(child, visitor, context))\r\n    );\r\n  }\r\n\r\n  return Promise.resolve();\r\n}\r\n"],"names":["assign","obj","props","i","getChildren","accumulator","children","Array","isArray","reduce","push","prepass","vnode","visitor","context","Promise","resolve","nodeName","type","Fragment","Suspense","doRender","c","__c","Component","__d","__v","undefined","state","isClassComponent","cxType","contextType","provider","cctx","value","prototype","render","getDerivedStateFromProps","componentWillMount","options","__r","e","then","reject","previousSkipEffects","renderResult","call","rendered","getChildContext","all","map","node","length","child"],"mappings":"wSASgBA,EAAOC,EAAmBC,GACxC,IAAK,IAAIC,KAAKD,EAAOD,EAAIE,GAAKD,EAAMC,GACpC,OAAOF,WAUOG,EACdC,EACAC,GAOA,OALIC,MAAMC,QAAQF,GAChBA,EAASG,OAAOL,EAAaC,GACR,MAAZC,IAAiC,IAAbA,GAC7BD,EAAYK,KAAKJ,GAEZD,SCPT,SAAwBM,EACtBC,EACAC,EACAC,GAGA,GAAa,MAATF,GAAkC,iBAAVA,EAC1B,OAAOG,QAAQC,UAGjB,IAAIC,EAAWL,EAAMM,KACnBhB,EAAQU,EAAMV,MACdI,EAAW,GAGb,GAFAQ,EAAUA,GAAW,GAGC,mBAAbG,GACPA,IAAaE,YACbF,IAAaG,WACb,CACA,IAAIC,EACAC,EAAKV,EAAMW,IAAM,IAAIC,YAAUtB,EAAOY,GAE1CQ,EAAEG,KAAM,EACRH,EAAEI,IAAMd,OAEQe,IAAZL,EAAEM,QACJN,EAAEM,MAAQ,IAGZ,IAAIC,GAAmB,EAInBC,EAASb,EAASc,YAClBC,EAAWF,GAAUhB,EAAQgB,EAAOP,KACpCU,EACQ,MAAVH,EACIE,EACEA,EAAS9B,MAAMgC,MACfJ,EAAM,KACNA,EAAM,GACRhB,EAkEN,OA/DGG,EAASkB,WAC2B,mBAA9BlB,EAASkB,UAAUC,QAwB1BP,GAAmB,EAInBP,EAAIV,EAAMW,IAAM,IAAIN,EAASf,EAAO+B,GAEpCX,EAAEG,KAAM,EACRH,EAAEI,IAAMd,EACRU,EAAEpB,MAAQA,EACVoB,EAAER,QAAUmB,OACIN,IAAZL,EAAEM,QACJN,EAAEM,MAAQ,IAIRX,EAASoB,yBACXf,EAAEM,MAAQ5B,EACRA,EAAO,GAAIsB,EAAEM,OACbX,EAASoB,yBAAyBf,EAAEpB,MAAOoB,EAAEM,QAExCN,EAAEgB,oBAAoBhB,EAAEgB,qBAEjCjB,EAAW,KACT,IAIE,OAFIkB,UAAQH,QAAQG,UAAQH,OAAOxB,GAC/B2B,UAAQC,KAAKD,UAAQC,IAAI5B,GACtBG,QAAQC,QAAQM,EAAEc,OAAOd,EAAEpB,MAAOoB,EAAEM,MAAON,EAAER,UACpD,MAAO2B,GACP,OAAIA,GAAKA,EAAEC,KACFD,EAAEC,KAAKrB,EAAUA,GAGnBN,QAAQ4B,OAAOF,MAtD1BpB,EAAW,KACT,IACE,MAAMuB,EAAsBL,UAAO,IACnCA,UAAO,KAAiB,EAEpBA,UAAQH,QAAQG,UAAQH,OAAOxB,GAC/B2B,UAAQC,KAAKD,UAAQC,IAAI5B,GAC7B,MAAMiC,EAAe9B,QAAQC,QAC3BC,EAAS6B,KAAKlC,EAAMW,IAAKrB,EAAO+B,IAGlC,OADAM,UAAO,IAAiBK,EACjBC,EACP,MAAOJ,GACP,OAAIA,GAAKA,EAAEC,KACFD,EAAEC,KAAKrB,EAAUA,GAGnBN,QAAQ4B,OAAOF,MA0CpB5B,GAEFA,EAAQD,EAAOiB,EAAmBP,OAAIK,IAAcZ,QAAQC,WAC5D0B,KAAKrB,GACPA,KACFqB,KAAMK,IACFzB,EAAE0B,kBACJlC,EAAUd,EAAOA,EAAO,GAAIc,GAAUQ,EAAE0B,oBAGtCzC,MAAMC,QAAQuC,GACThC,QAAQkC,IACbF,EAASG,IAAKC,GAASxC,EAAQwC,EAAMtC,EAASC,KAI3CH,EAAQoC,EAAUlC,EAASC,KAItC,OAAIZ,GAASE,EAAaE,EAAW,GAAKJ,EAAMI,UAAU8C,OACjDrC,QAAQkC,IACb3C,EAAS4C,IAAKG,GAAU1C,EAAQ0C,EAAOxC,EAASC,KAI7CC,QAAQC"}